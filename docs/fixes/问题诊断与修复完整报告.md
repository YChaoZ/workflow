# 工作流系统启动问题诊断与修复完整报告

## 问题症状

启动服务时出现以下错误循环：
1. Flyway迁移失败：`Table 'wf_process_category' already exists`
2. 字段不匹配：`Unknown column 'name' in 'field list'`
3. 重复键冲突：`Duplicate entry 'hr' for key 'wf_process_category.uk_code'`

## 根本原因分析

### 1. 数据库迁移脚本冲突

**问题：** V1和V3都定义了`wf_process_category`表，但字段名不同

- **V1表定义**（正确）：
  ```sql
  category_code VARCHAR(50)
  category_name VARCHAR(100)
  create_time DATETIME
  update_time DATETIME
  ```

- **V3表定义**（错误-重复）：
  ```sql
  code VARCHAR(50)
  name VARCHAR(100)
  created_time DATETIME
  updated_time DATETIME
  ```

**后果：** 
- V3的`CREATE TABLE IF NOT EXISTS`看到V1已创建表，跳过创建
- 但V4脚本使用V3的字段名(`name`, `code`)插入数据
- 实际表使用V1的字段名(`category_name`, `category_code`)
- 导致`Unknown column 'name'`错误

### 2. 初始化数据重复插入

**问题：** V2和V4都插入了基础分类数据

- **V2插入**：`APPROVAL`, `FINANCE`, `HR`, `OA`
- **V4再次插入**：`administration`, `hr`, `finance`, `procurement`, `project`
  
**后果：**
- MySQL唯一索引不区分大小写
- `HR`（V2）与`hr`（V4）冲突
- 报错：`Duplicate entry 'hr' for key 'wf_process_category.uk_code'`

### 3. DO类字段名与数据库不匹配

**问题：** ProcessCategoryDO的Java字段名与数据库列名不匹配

- **Java字段**：`name`, `code`, `createdTime`, `updatedTime`
- **数据库列**：`category_name`, `category_code`, `create_time`, `update_time`
- **MyBatis-Plus生成SQL**：使用Java字段名，期望驼峰转下划线生效
- **实际情况**：由于字段名本身不是驼峰格式，转换后还是错误

### 4. 旧Java进程未完全停止

**问题：** 代码修改后，旧的Java进程仍在运行

**后果：**
- 即使重新编译打包，旧进程使用旧的class文件
- API一直返回相同的错误
- 误以为代码修改没有生效

## 修复方案

### 1. 修复数据库迁移脚本

**V3__mvp2_tables.sql**
```sql
-- MVP2阶段新增表
-- 注意：wf_process_category表已在V1中创建，这里不再重复创建

-- 1. 任务意见表
CREATE TABLE IF NOT EXISTS wf_task_comment (
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务意见表';

-- 2. 任务附件表
CREATE TABLE IF NOT EXISTS wf_task_attachment (
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务附件表';
```

### 2. 修复初始化数据脚本

**V4__mvp2_init_data.sql**
```sql
-- MVP2阶段初始化数据
-- 注意：V2已经插入了基础分类（APPROVAL, FINANCE, HR, OA），这里只插入详细分类

-- 使用V2插入的HR分类作为父分类，添加人事管理子分类
INSERT INTO wf_process_category (category_name, category_code, parent_id, sort_order) 
SELECT '请假审批', 'HR_LEAVE', id, 1 FROM wf_process_category WHERE category_code='HR';

INSERT INTO wf_process_category (category_name, category_code, parent_id, sort_order) 
SELECT '出差申请', 'HR_TRAVEL', id, 2 FROM wf_process_category WHERE category_code='HR';
...
```

### 3. 修复DO类字段映射

**ProcessCategoryDO.java**
```java
@Data
@TableName("wf_process_category")
public class ProcessCategoryDO {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    // 直接使用与数据库匹配的驼峰命名，MyBatis-Plus自动转下划线
    private String categoryName;  // -> category_name
    private String categoryCode;  // -> category_code
    private Long parentId;        // -> parent_id
    private Integer sortOrder;    // -> sort_order
    private Date createTime;      // -> create_time
    private Date updateTime;      // -> update_time
}
```

### 4. 手动映射DO和Entity

**ProcessCategoryGatewayImpl.java**
```java
private ProcessCategory convertToEntity(ProcessCategoryDO categoryDO) {
    ProcessCategory category = new ProcessCategory();
    category.setId(categoryDO.getId());
    category.setName(categoryDO.getCategoryName());    // 手动映射
    category.setCode(categoryDO.getCategoryCode());    // 手动映射
    category.setParentId(categoryDO.getParentId());
    category.setSortOrder(categoryDO.getSortOrder());
    category.setCreatedTime(categoryDO.getCreateTime());
    category.setUpdatedTime(categoryDO.getUpdateTime());
    return category;
}

private ProcessCategoryDO convertToDO(ProcessCategory category) {
    ProcessCategoryDO categoryDO = new ProcessCategoryDO();
    categoryDO.setId(category.getId());
    categoryDO.setCategoryName(category.getName());    // 手动映射
    categoryDO.setCategoryCode(category.getCode());    // 手动映射
    categoryDO.setParentId(category.getParentId());
    categoryDO.setSortOrder(category.getSortOrder());
    return categoryDO;
}
```

### 5. 数据库完全重置

```sql
USE workflow;

-- 删除所有wf_和sys_表
DROP TABLE IF EXISTS wf_task_attachment;
DROP TABLE IF EXISTS wf_task_comment;
DROP TABLE IF EXISTS wf_process_category;
DROP TABLE IF EXISTS wf_task_ext;
DROP TABLE IF EXISTS wf_task_copy;
DROP TABLE IF EXISTS wf_process_instance_ext;
DROP TABLE IF EXISTS wf_process_definition_ext;
DROP TABLE IF EXISTS wf_monitor_record;
DROP TABLE IF EXISTS wf_form_definition;
DROP TABLE IF EXISTS wf_form_data;
DROP TABLE IF EXISTS sys_user_role;
DROP TABLE IF EXISTS sys_role;
DROP TABLE IF EXISTS sys_department;
DROP TABLE IF EXISTS sys_user;

-- 清空Flyway历史
TRUNCATE TABLE flyway_schema_history;
```

### 6. 完全停止并重启服务

```bash
# 停止所有workflow相关进程
jps -l | grep workflow | awk '{print $1}' | xargs -r kill -9
pkill -9 -f "workflow"

# 重新编译打包
cd backend
mvn clean package -DskipTests

# 启动服务
java -jar target/workflow-system-1.0.0-SNAPSHOT.jar --spring.profiles.active=dev
```

## 验证结果

### 1. Flyway迁移成功
```
version	description	        success
1	    init tables	        1
2	    init data	        1
3	    mvp2 tables	        1
4	    mvp2 init data	    1
```

### 2. 数据正确插入
```
id	category_code	        category_name	parent_id
1	APPROVAL	            审批流程	    0
2	FINANCE	                财务流程	    0
3	HR	                    人事流程	    0
4	OA	                    办公流程	    0
18	APPROVAL_SEAL	        用印申请	    1
15	FINANCE_REIMBURSEMENT	报销申请	    2
16	FINANCE_PAYMENT	        付款申请	    2
17	FINANCE_LOAN	        借款申请	    2
10	HR_LEAVE	            请假审批	    3
11	HR_TRAVEL	            出差申请	    3
12	HR_ONBOARDING	        入职申请	    3
13	HR_RESIGNATION	        离职申请	    3
14	HR_REGULARIZATION	    转正申请	    3
```

### 3. API测试成功

**列表API**
```bash
curl http://localhost:9099/api/process/category/list
```
返回：200 OK，包含所有13条分类数据

**树形API**
```bash
curl http://localhost:9099/api/process/category/tree
```
返回：200 OK，正确的父子树形结构

## 经验教训

1. **数据库迁移脚本要避免重复定义表**
   - 同一个表只在一个版本中定义
   - 后续版本如需修改，使用ALTER TABLE

2. **字段命名要统一**
   - DO类字段名使用Java驼峰命名
   - 依赖MyBatis-Plus的驼峰转下划线功能
   - 数据库使用下划线命名

3. **手动映射比BeanUtils更可靠**
   - 字段名不完全匹配时，BeanUtils.copyProperties会静默失败
   - 手动映射虽然繁琐，但类型安全且明确

4. **测试时要确保进程完全重启**
   - 使用jps查看所有Java进程
   - kill -9确保进程完全停止
   - 重新打包前删除target目录

5. **Flyway迁移要原子性**
   - 失败后清理Flyway历史表
   - 重新执行前确保表和数据都已清理

## 相关文件

- `/backend/src/main/resources/db/migration/V1__init_tables.sql` - 基础表定义
- `/backend/src/main/resources/db/migration/V2__init_data.sql` - 基础数据
- `/backend/src/main/resources/db/migration/V3__mvp2_tables.sql` - MVP2表（已修复）
- `/backend/src/main/resources/db/migration/V4__mvp2_init_data.sql` - MVP2数据（已修复）
- `/backend/src/main/java/com/bank/workflow/infrastructure/persistence/po/ProcessCategoryDO.java` - 持久化对象（已修复）
- `/backend/src/main/java/com/bank/workflow/infrastructure/gateway/ProcessCategoryGatewayImpl.java` - 网关实现（已修复）

## 服务访问地址

- **应用地址**：http://localhost:9099
- **API文档**：http://localhost:9099/doc.html
- **Druid监控**：http://localhost:9099/druid/

---

**修复完成时间**：2025-11-06  
**状态**：✅ 所有问题已解决，服务正常运行

