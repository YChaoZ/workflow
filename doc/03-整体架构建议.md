# 整体架构建议

## 一、文档概述

本文档基于以下技术选型，提供完整的工作流系统架构设计方案：

**后端技术栈**：
- 工作流引擎：Flowable 7.x
- 架构规范：阿里 COLA 架构
- 数据库：MySQL 8.0+
- 框架：Spring Boot 3.x

**前端技术栈**：
- 前端框架：Vue 3 + Element Plus
- 流程设计器：bpmn-js
- 构建工具：Vite

## 二、COLA 架构适配方案

### 2.1 COLA 架构简介

COLA（Clean Object-Oriented and Layered Architecture）是阿里巴巴提出的应用架构规范，强调分层、领域驱动和整洁架构。

**核心理念**：
- 分层架构（Layered Architecture）
- 领域驱动设计（DDD）
- 依赖倒置原则（DIP）
- 整洁架构（Clean Architecture）

**四层架构**：
```
├── adapter 层      // 适配器层（Controller、MQ、定时任务等）
├── app 层          // 应用层（Application Service、Command、Query）
├── domain 层       // 领域层（Entity、ValueObject、DomainService）
└── infrastructure 层 // 基础设施层（Repository实现、外部服务调用）
```

### 2.2 项目结构设计

#### 2.2.1 完整项目结构

```
workfolw/                                    # 项目根目录
├── workfolw-adapter/                        # 适配器层
│   ├── src/main/java/com/bank/workfolw/adapter/
│   │   ├── web/                             # Web适配器
│   │   │   ├── ProcessController.java       # 流程控制器
│   │   │   ├── TaskController.java          # 任务控制器
│   │   │   ├── FormController.java          # 表单控制器
│   │   │   ├── OrgController.java           # 组织架构控制器
│   │   │   └── MonitorController.java       # 监控控制器
│   │   ├── event/                           # 事件适配器
│   │   │   └── ProcessEventListener.java    # 流程事件监听
│   │   ├── scheduler/                       # 定时任务适配器
│   │   │   └── ProcessTimeoutJob.java       # 流程超时任务
│   │   └── converter/                       # 转换器
│   │       └── ProcessDTOConverter.java     # DTO转换器
│   └── pom.xml
│
├── workfolw-app/                            # 应用层
│   ├── src/main/java/com/bank/workfolw/app/
│   │   ├── process/                         # 流程应用服务
│   │   │   ├── ProcessAppService.java       # 流程应用服务
│   │   │   ├── command/                     # 命令
│   │   │   │   ├── StartProcessCmd.java     # 启动流程命令
│   │   │   │   ├── CompleteTaskCmd.java     # 完成任务命令
│   │   │   │   └── SuspendProcessCmd.java   # 挂起流程命令
│   │   │   ├── query/                       # 查询
│   │   │   │   ├── ProcessInstanceQry.java  # 流程实例查询
│   │   │   │   └── ProcessDefinitionQry.java # 流程定义查询
│   │   │   └── executor/                    # 执行器
│   │   │       ├── StartProcessCmdExe.java
│   │   │       └── CompleteTaskCmdExe.java
│   │   ├── task/                            # 任务应用服务
│   │   │   ├── TaskAppService.java
│   │   │   ├── command/
│   │   │   ├── query/
│   │   │   └── executor/
│   │   ├── form/                            # 表单应用服务
│   │   │   └── FormAppService.java
│   │   ├── org/                             # 组织架构应用服务
│   │   │   └── OrgAppService.java
│   │   └── dto/                             # 数据传输对象
│   │       ├── ProcessDTO.java
│   │       └── TaskDTO.java
│   └── pom.xml
│
├── workfolw-domain/                         # 领域层
│   ├── src/main/java/com/bank/workfolw/domain/
│   │   ├── process/                         # 流程领域
│   │   │   ├── entity/                      # 实体
│   │   │   │   ├── ProcessDefinition.java   # 流程定义
│   │   │   │   ├── ProcessInstance.java     # 流程实例
│   │   │   │   └── ProcessVariable.java     # 流程变量
│   │   │   ├── gateway/                     # 领域网关（接口）
│   │   │   │   ├── ProcessGateway.java      # 流程网关
│   │   │   │   └── ProcessEngineGateway.java # 流程引擎网关
│   │   │   ├── service/                     # 领域服务
│   │   │   │   ├── ProcessDomainService.java
│   │   │   │   └── ProcessValidator.java    # 流程校验服务
│   │   │   └── event/                       # 领域事件
│   │   │       └── ProcessStartedEvent.java
│   │   ├── task/                            # 任务领域
│   │   │   ├── entity/
│   │   │   │   ├── Task.java
│   │   │   │   └── TaskAssignee.java
│   │   │   ├── gateway/
│   │   │   │   └── TaskGateway.java
│   │   │   └── service/
│   │   │       └── TaskDomainService.java
│   │   ├── form/                            # 表单领域
│   │   │   ├── entity/
│   │   │   │   ├── FormDefinition.java
│   │   │   │   └── FormData.java
│   │   │   └── gateway/
│   │   │       └── FormGateway.java
│   │   ├── org/                             # 组织架构领域
│   │   │   ├── entity/
│   │   │   │   ├── Department.java
│   │   │   │   ├── User.java
│   │   │   │   └── Role.java
│   │   │   └── gateway/
│   │   │       └── OrgGateway.java
│   │   └── common/                          # 公共领域
│   │       ├── entity/
│   │       │   └── BaseEntity.java
│   │       └── exception/
│   │           └── BusinessException.java
│   └── pom.xml
│
├── workfolw-infrastructure/                 # 基础设施层
│   ├── src/main/java/com/bank/workfolw/infrastructure/
│   │   ├── process/                         # 流程基础设施
│   │   │   ├── gateway/                     # 网关实现
│   │   │   │   ├── ProcessGatewayImpl.java
│   │   │   │   └── ProcessEngineGatewayImpl.java
│   │   │   ├── repository/                  # 仓储
│   │   │   │   └── ProcessRepository.java
│   │   │   ├── mapper/                      # MyBatis Mapper
│   │   │   │   └── ProcessMapper.java
│   │   │   └── converter/                   # 转换器
│   │   │       └── ProcessConverter.java
│   │   ├── task/
│   │   │   ├── gateway/
│   │   │   │   └── TaskGatewayImpl.java
│   │   │   └── repository/
│   │   ├── form/
│   │   │   └── gateway/
│   │   ├── org/
│   │   │   └── gateway/
│   │   ├── flowable/                        # Flowable配置
│   │   │   ├── config/
│   │   │   │   ├── FlowableConfig.java      # Flowable配置
│   │   │   │   └── AsyncExecutorConfig.java # 异步执行器配置
│   │   │   ├── listener/                    # 监听器
│   │   │   │   ├── GlobalTaskListener.java  # 全局任务监听器
│   │   │   │   └── GlobalExecutionListener.java
│   │   │   └── handler/                     # 处理器
│   │   │       └── CustomUserTaskHandler.java
│   │   └── common/                          # 公共基础设施
│   │       ├── config/
│   │       │   ├── DataSourceConfig.java
│   │       │   ├── MybatisConfig.java
│   │       │   └── RedisConfig.java
│   │       └── util/
│   └── pom.xml
│
├── workfolw-start/                          # 启动模块
│   ├── src/main/java/com/bank/workfolw/
│   │   └── WorkFlowApplication.java
│   ├── src/main/resources/
│   │   ├── application.yml                  # 应用配置
│   │   ├── application-dev.yml              # 开发环境配置
│   │   ├── application-prod.yml             # 生产环境配置
│   │   ├── processes/                       # BPMN流程文件
│   │   │   └── example-process.bpmn20.xml
│   │   └── db/migration/                    # 数据库迁移脚本
│   │       ├── V1__init_schema.sql
│   │       └── V2__flowable_tables.sql
│   └── pom.xml
│
└── pom.xml                                  # 父POM
```

#### 2.2.2 各层职责详解

##### Adapter 层（适配器层）

**职责**：
- 接收外部请求（HTTP、MQ、定时任务等）
- 调用 App 层的应用服务
- 返回响应给外部系统
- 不包含业务逻辑

**示例代码**：
```java
package com.bank.workfolw.adapter.web;

import com.alibaba.cola.dto.Response;
import com.bank.workfolw.app.process.ProcessAppService;
import com.bank.workfolw.app.process.command.StartProcessCmd;
import com.bank.workfolw.app.dto.ProcessDTO;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

/**
 * 流程控制器
 */
@RestController
@RequestMapping("/api/process")
@RequiredArgsConstructor
public class ProcessController {
    
    private final ProcessAppService processAppService;
    
    /**
     * 启动流程
     */
    @PostMapping("/start")
    public Response<String> startProcess(@RequestBody StartProcessCmd cmd) {
        return processAppService.startProcess(cmd);
    }
    
    /**
     * 查询流程实例
     */
    @GetMapping("/instance/{instanceId}")
    public Response<ProcessDTO> getProcessInstance(@PathVariable String instanceId) {
        return processAppService.getProcessInstance(instanceId);
    }
    
    /**
     * 挂起流程实例
     */
    @PostMapping("/instance/{instanceId}/suspend")
    public Response<Void> suspendProcessInstance(@PathVariable String instanceId) {
        return processAppService.suspendProcessInstance(instanceId);
    }
}
```

##### App 层（应用层）

**职责**：
- 编排领域服务
- 处理事务
- 转换 DTO
- 不包含业务规则

**CQRS 模式**：
- Command（命令）：修改操作
- Query（查询）：查询操作
- Executor（执行器）：具体执行逻辑

**示例代码**：
```java
package com.bank.workfolw.app.process;

import com.alibaba.cola.dto.Response;
import com.bank.workfolw.app.process.command.StartProcessCmd;
import com.bank.workfolw.app.process.executor.StartProcessCmdExe;
import com.bank.workfolw.app.dto.ProcessDTO;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

/**
 * 流程应用服务
 */
@Service
@RequiredArgsConstructor
public class ProcessAppService {
    
    private final StartProcessCmdExe startProcessCmdExe;
    
    /**
     * 启动流程
     */
    public Response<String> startProcess(StartProcessCmd cmd) {
        return startProcessCmdExe.execute(cmd);
    }
}
```

```java
package com.bank.workfolw.app.process.command;

import com.alibaba.cola.dto.Command;
import lombok.Data;
import java.util.Map;

/**
 * 启动流程命令
 */
@Data
public class StartProcessCmd extends Command {
    /** 流程定义KEY */
    private String processKey;
    /** 业务KEY */
    private String businessKey;
    /** 流程变量 */
    private Map<String, Object> variables;
    /** 启动人 */
    private String startUser;
}
```

```java
package com.bank.workfolw.app.process.executor;

import com.alibaba.cola.dto.Response;
import com.bank.workfolw.app.process.command.StartProcessCmd;
import com.bank.workfolw.domain.process.entity.ProcessInstance;
import com.bank.workfolw.domain.process.gateway.ProcessEngineGateway;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

/**
 * 启动流程命令执行器
 */
@Component
@RequiredArgsConstructor
public class StartProcessCmdExe {
    
    private final ProcessEngineGateway processEngineGateway;
    
    @Transactional(rollbackFor = Exception.class)
    public Response<String> execute(StartProcessCmd cmd) {
        // 1. 参数校验
        validateCommand(cmd);
        
        // 2. 调用领域服务启动流程
        ProcessInstance instance = processEngineGateway.startProcess(
            cmd.getProcessKey(),
            cmd.getBusinessKey(),
            cmd.getVariables(),
            cmd.getStartUser()
        );
        
        // 3. 返回流程实例ID
        return Response.buildSuccess(instance.getInstanceId());
    }
    
    private void validateCommand(StartProcessCmd cmd) {
        // 参数校验逻辑
    }
}
```

##### Domain 层（领域层）

**职责**：
- 核心业务逻辑
- 领域模型（实体、值对象）
- 领域服务
- 领域事件
- 定义 Gateway 接口（由 Infrastructure 实现）

**示例代码**：
```java
package com.bank.workfolw.domain.process.entity;

import com.bank.workfolw.domain.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import java.util.Date;
import java.util.Map;

/**
 * 流程实例领域实体
 */
@Data
@EqualsAndHashCode(callSuper = true)
public class ProcessInstance extends BaseEntity {
    /** 流程实例ID */
    private String instanceId;
    /** 流程定义ID */
    private String processDefinitionId;
    /** 流程定义KEY */
    private String processKey;
    /** 业务KEY */
    private String businessKey;
    /** 流程名称 */
    private String processName;
    /** 流程状态：RUNNING, SUSPENDED, COMPLETED */
    private String status;
    /** 启动人 */
    private String startUser;
    /** 启动时间 */
    private Date startTime;
    /** 结束时间 */
    private Date endTime;
    /** 流程变量 */
    private Map<String, Object> variables;
    
    /**
     * 挂起流程
     */
    public void suspend() {
        if ("COMPLETED".equals(this.status)) {
            throw new IllegalStateException("已完成的流程不能挂起");
        }
        this.status = "SUSPENDED";
    }
    
    /**
     * 激活流程
     */
    public void activate() {
        if (!"SUSPENDED".equals(this.status)) {
            throw new IllegalStateException("只有挂起的流程才能激活");
        }
        this.status = "RUNNING";
    }
    
    /**
     * 完成流程
     */
    public void complete() {
        this.status = "COMPLETED";
        this.endTime = new Date();
    }
}
```

```java
package com.bank.workfolw.domain.process.gateway;

import com.bank.workfolw.domain.process.entity.ProcessInstance;
import java.util.Map;

/**
 * 流程引擎网关接口（由Infrastructure层实现）
 */
public interface ProcessEngineGateway {
    
    /**
     * 启动流程
     */
    ProcessInstance startProcess(String processKey, String businessKey, 
                                  Map<String, Object> variables, String startUser);
    
    /**
     * 挂起流程实例
     */
    void suspendProcessInstance(String instanceId);
    
    /**
     * 激活流程实例
     */
    void activateProcessInstance(String instanceId);
    
    /**
     * 查询流程实例
     */
    ProcessInstance getProcessInstance(String instanceId);
}
```

##### Infrastructure 层（基础设施层）

**职责**：
- 实现 Domain 层定义的 Gateway 接口
- 与外部系统交互（数据库、Flowable、Redis等）
- 技术实现细节

**示例代码**：
```java
package com.bank.workfolw.infrastructure.process.gateway;

import com.bank.workfolw.domain.process.entity.ProcessInstance;
import com.bank.workfolw.domain.process.gateway.ProcessEngineGateway;
import com.bank.workfolw.infrastructure.process.converter.ProcessConverter;
import lombok.RequiredArgsConstructor;
import org.flowable.engine.RuntimeService;
import org.flowable.engine.runtime.ProcessInstanceBuilder;
import org.springframework.stereotype.Component;
import java.util.Map;

/**
 * 流程引擎网关实现（基于Flowable）
 */
@Component
@RequiredArgsConstructor
public class ProcessEngineGatewayImpl implements ProcessEngineGateway {
    
    private final RuntimeService runtimeService;
    private final ProcessConverter processConverter;
    
    @Override
    public ProcessInstance startProcess(String processKey, String businessKey,
                                        Map<String, Object> variables, String startUser) {
        // 使用Flowable API启动流程
        ProcessInstanceBuilder builder = runtimeService.createProcessInstanceBuilder()
            .processDefinitionKey(processKey)
            .businessKey(businessKey)
            .variables(variables);
        
        // 设置启动人
        if (startUser != null) {
            builder.startUserIdentityId(startUser);
        }
        
        org.flowable.engine.runtime.ProcessInstance flowableInstance = builder.start();
        
        // 转换为领域对象
        return processConverter.toProcessInstance(flowableInstance);
    }
    
    @Override
    public void suspendProcessInstance(String instanceId) {
        runtimeService.suspendProcessInstanceById(instanceId);
    }
    
    @Override
    public void activateProcessInstance(String instanceId) {
        runtimeService.activateProcessInstanceById(instanceId);
    }
    
    @Override
    public ProcessInstance getProcessInstance(String instanceId) {
        org.flowable.engine.runtime.ProcessInstance flowableInstance = 
            runtimeService.createProcessInstanceQuery()
                .processInstanceId(instanceId)
                .singleResult();
        
        return processConverter.toProcessInstance(flowableInstance);
    }
}
```

### 2.3 Flowable 集成配置

#### 2.3.1 Maven 依赖

```xml
<!-- 父POM依赖管理 -->
<dependencyManagement>
    <dependencies>
        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>3.2.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        
        <!-- COLA Framework -->
        <dependency>
            <groupId>com.alibaba.cola</groupId>
            <artifactId>cola-component-dto</artifactId>
            <version>4.3.2</version>
        </dependency>
        
        <!-- Flowable -->
        <dependency>
            <groupId>org.flowable</groupId>
            <artifactId>flowable-spring-boot-starter</artifactId>
            <version>7.0.1</version>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- infrastructure 模块的依赖 -->
<dependencies>
    <dependency>
        <groupId>org.flowable</groupId>
        <artifactId>flowable-spring-boot-starter</artifactId>
    </dependency>
    
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter</artifactId>
        <version>3.0.3</version>
    </dependency>
</dependencies>
```

#### 2.3.2 Flowable 配置

```java
package com.bank.workfolw.infrastructure.flowable.config;

import org.flowable.spring.SpringProcessEngineConfiguration;
import org.flowable.spring.boot.EngineConfigurationConfigurer;
import org.springframework.context.annotation.Configuration;

/**
 * Flowable配置
 */
@Configuration
public class FlowableConfig implements EngineConfigurationConfigurer<SpringProcessEngineConfiguration> {
    
    @Override
    public void configure(SpringProcessEngineConfiguration engineConfiguration) {
        // 自动部署流程定义
        engineConfiguration.setDeploymentResources("classpath*:processes/*.bpmn20.xml");
        
        // 异步执行器配置
        engineConfiguration.setAsyncExecutorActivate(true);
        engineConfiguration.setAsyncExecutorCorePoolSize(5);
        engineConfiguration.setAsyncExecutorMaxPoolSize(10);
        
        // 历史记录级别
        engineConfiguration.setHistoryLevel("full");
        
        // 字体配置（解决流程图中文乱码）
        engineConfiguration.setActivityFontName("宋体");
        engineConfiguration.setLabelFontName("宋体");
        engineConfiguration.setAnnotationFontName("宋体");
    }
}
```

```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/workflow?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
    
flowable:
  # 数据库类型
  database-schema-update: true
  # 关闭定时任务JOB
  async-executor-activate: true
  # 邮件服务器配置
  mail-server-host: smtp.example.com
  mail-server-port: 25
```

## 三、数据库设计

### 3.1 数据库表规划

#### 3.1.1 Flowable 核心表（自动创建）

Flowable 会自动创建约 70+ 张表，主要分为以下几类：

| 表前缀 | 说明 | 表数量 |
|--------|------|--------|
| ACT_RE_* | Repository（流程定义、部署） | 4 |
| ACT_RU_* | Runtime（运行时数据） | 10+ |
| ACT_HI_* | History（历史数据） | 10+ |
| ACT_ID_* | Identity（用户、组） | 4 |
| ACT_GE_* | General（通用数据） | 3 |

**重要表说明**：

```sql
-- 流程定义表
ACT_RE_PROCDEF          -- 流程定义信息
ACT_RE_DEPLOYMENT       -- 部署信息

-- 流程实例表
ACT_RU_EXECUTION        -- 流程执行信息
ACT_RU_TASK             -- 任务信息
ACT_RU_VARIABLE         -- 流程变量

-- 历史表
ACT_HI_PROCINST         -- 流程实例历史
ACT_HI_TASKINST         -- 任务历史
ACT_HI_ACTINST          -- 活动历史
ACT_HI_VARINST          -- 变量历史
```

#### 3.1.2 业务扩展表设计

```sql
-- ========================================
-- 流程管理相关表
-- ========================================

-- 流程分类表
CREATE TABLE wf_process_category (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    category_code VARCHAR(50) NOT NULL COMMENT '分类编码',
    category_name VARCHAR(100) NOT NULL COMMENT '分类名称',
    parent_id BIGINT DEFAULT 0 COMMENT '父分类ID',
    sort_order INT DEFAULT 0 COMMENT '排序',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_code (category_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程分类表';

-- 流程定义扩展表
CREATE TABLE wf_process_definition_ext (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    process_definition_id VARCHAR(64) NOT NULL COMMENT 'Flowable流程定义ID',
    process_key VARCHAR(50) NOT NULL COMMENT '流程KEY',
    process_name VARCHAR(100) NOT NULL COMMENT '流程名称',
    category_id BIGINT COMMENT '分类ID',
    version INT DEFAULT 1 COMMENT '版本号',
    description TEXT COMMENT '流程描述',
    icon VARCHAR(200) COMMENT '图标',
    form_id BIGINT COMMENT '关联表单ID',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    create_user VARCHAR(50) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    KEY idx_process_key (process_key),
    KEY idx_category (category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程定义扩展表';

-- 流程实例扩展表
CREATE TABLE wf_process_instance_ext (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    process_instance_id VARCHAR(64) NOT NULL COMMENT 'Flowable流程实例ID',
    business_key VARCHAR(100) COMMENT '业务KEY',
    business_type VARCHAR(50) COMMENT '业务类型',
    business_id VARCHAR(100) COMMENT '业务ID',
    title VARCHAR(200) COMMENT '流程标题',
    priority INT DEFAULT 0 COMMENT '优先级',
    start_user VARCHAR(50) COMMENT '发起人',
    start_dept VARCHAR(100) COMMENT '发起部门',
    current_node VARCHAR(100) COMMENT '当前节点',
    status VARCHAR(20) COMMENT '状态：RUNNING,SUSPENDED,COMPLETED,TERMINATED',
    result VARCHAR(20) COMMENT '结果：APPROVED,REJECTED',
    remark TEXT COMMENT '备注',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    end_time DATETIME COMMENT '结束时间',
    KEY idx_instance_id (process_instance_id),
    KEY idx_business_key (business_key),
    KEY idx_start_user (start_user),
    KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程实例扩展表';

-- ========================================
-- 表单管理相关表
-- ========================================

-- 表单定义表
CREATE TABLE wf_form_definition (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    form_key VARCHAR(50) NOT NULL COMMENT '表单KEY',
    form_name VARCHAR(100) NOT NULL COMMENT '表单名称',
    form_type VARCHAR(20) DEFAULT 'CUSTOM' COMMENT '表单类型：CUSTOM-自定义,EXTERNAL-外部',
    form_config JSON COMMENT '表单配置（JSON）',
    form_schema JSON COMMENT '表单Schema',
    version INT DEFAULT 1 COMMENT '版本号',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    remark TEXT COMMENT '备注',
    create_user VARCHAR(50) COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_form_key (form_key),
    KEY idx_form_name (form_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='表单定义表';

-- 表单数据表
CREATE TABLE wf_form_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    form_id BIGINT NOT NULL COMMENT '表单ID',
    process_instance_id VARCHAR(64) COMMENT '流程实例ID',
    task_id VARCHAR(64) COMMENT '任务ID',
    form_data JSON NOT NULL COMMENT '表单数据（JSON）',
    submit_user VARCHAR(50) COMMENT '提交人',
    submit_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
    KEY idx_form_id (form_id),
    KEY idx_instance_id (process_instance_id),
    KEY idx_task_id (task_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='表单数据表';

-- ========================================
-- 任务管理相关表
-- ========================================

-- 任务扩展表
CREATE TABLE wf_task_ext (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    task_id VARCHAR(64) NOT NULL COMMENT 'Flowable任务ID',
    process_instance_id VARCHAR(64) NOT NULL COMMENT '流程实例ID',
    task_name VARCHAR(100) COMMENT '任务名称',
    assignee VARCHAR(50) COMMENT '办理人',
    owner VARCHAR(50) COMMENT '任务拥有者',
    candidate_users TEXT COMMENT '候选用户（逗号分隔）',
    candidate_groups TEXT COMMENT '候选组（逗号分隔）',
    due_date DATETIME COMMENT '截止时间',
    follow_up_date DATETIME COMMENT '跟进时间',
    priority INT DEFAULT 0 COMMENT '优先级',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    claim_time DATETIME COMMENT '签收时间',
    complete_time DATETIME COMMENT '完成时间',
    KEY idx_task_id (task_id),
    KEY idx_assignee (assignee),
    KEY idx_instance_id (process_instance_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务扩展表';

-- 任务意见表
CREATE TABLE wf_task_comment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    task_id VARCHAR(64) NOT NULL COMMENT '任务ID',
    process_instance_id VARCHAR(64) NOT NULL COMMENT '流程实例ID',
    comment_type VARCHAR(20) DEFAULT 'COMMENT' COMMENT '意见类型：COMMENT-批注,APPROVE-同意,REJECT-拒绝',
    comment_text TEXT COMMENT '意见内容',
    attachments TEXT COMMENT '附件（JSON数组）',
    user_id VARCHAR(50) COMMENT '用户ID',
    user_name VARCHAR(100) COMMENT '用户名称',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    KEY idx_task_id (task_id),
    KEY idx_instance_id (process_instance_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务意见表';

-- 抄送表
CREATE TABLE wf_task_copy (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    process_instance_id VARCHAR(64) NOT NULL COMMENT '流程实例ID',
    task_id VARCHAR(64) COMMENT '任务ID',
    title VARCHAR(200) COMMENT '标题',
    copy_user VARCHAR(50) NOT NULL COMMENT '抄送人',
    copy_reason VARCHAR(200) COMMENT '抄送原因',
    is_read TINYINT DEFAULT 0 COMMENT '是否已读：0-未读，1-已读',
    read_time DATETIME COMMENT '阅读时间',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    KEY idx_copy_user (copy_user),
    KEY idx_instance_id (process_instance_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='抄送表';

-- ========================================
-- 组织架构相关表
-- ========================================

-- 部门表
CREATE TABLE sys_department (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    dept_code VARCHAR(50) NOT NULL COMMENT '部门编码',
    dept_name VARCHAR(100) NOT NULL COMMENT '部门名称',
    parent_id BIGINT DEFAULT 0 COMMENT '父部门ID',
    dept_level INT DEFAULT 1 COMMENT '部门层级',
    dept_path VARCHAR(500) COMMENT '部门路径',
    manager_id BIGINT COMMENT '负责人ID',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_dept_code (dept_code),
    KEY idx_parent_id (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';

-- 用户表
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    real_name VARCHAR(100) COMMENT '真实姓名',
    password VARCHAR(100) COMMENT '密码',
    dept_id BIGINT COMMENT '部门ID',
    position VARCHAR(100) COMMENT '职位',
    email VARCHAR(100) COMMENT '邮箱',
    mobile VARCHAR(20) COMMENT '手机号',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_username (username),
    KEY idx_dept_id (dept_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 角色表
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    role_code VARCHAR(50) NOT NULL COMMENT '角色编码',
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    role_type VARCHAR(20) DEFAULT 'CUSTOM' COMMENT '角色类型',
    description VARCHAR(200) COMMENT '描述',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_role_code (role_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';

-- 用户角色关系表
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_user_role (user_id, role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关系表';

-- ========================================
-- 监控统计相关表
-- ========================================

-- 流程监控记录表
CREATE TABLE wf_monitor_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
    process_instance_id VARCHAR(64) NOT NULL COMMENT '流程实例ID',
    node_key VARCHAR(100) COMMENT '节点KEY',
    node_name VARCHAR(100) COMMENT '节点名称',
    event_type VARCHAR(20) COMMENT '事件类型：START,END,TIMEOUT',
    duration BIGINT COMMENT '持续时间（毫秒）',
    record_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
    KEY idx_instance_id (process_instance_id),
    KEY idx_record_time (record_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程监控记录表';
```

### 3.2 索引优化建议

```sql
-- Flowable表索引优化
ALTER TABLE ACT_RU_TASK ADD INDEX idx_assignee_status (ASSIGNEE_, SUSPENSION_STATE_);
ALTER TABLE ACT_HI_TASKINST ADD INDEX idx_assignee_end (ASSIGNEE_, END_TIME_);
ALTER TABLE ACT_HI_PROCINST ADD INDEX idx_start_end_time (START_TIME_, END_TIME_);
```

## 四、前后端接口设计

### 4.1 RESTful API 设计规范

#### 4.1.1 URL 设计规范

```
基础规范：
- 使用名词复数形式
- 使用小写字母，单词间用连字符 -
- 版本号放在 URL 中：/api/v1/
- 资源嵌套不超过 3 层

示例：
GET    /api/v1/processes                    # 查询流程列表
POST   /api/v1/processes                    # 创建流程
GET    /api/v1/processes/{id}               # 查询流程详情
PUT    /api/v1/processes/{id}               # 更新流程
DELETE /api/v1/processes/{id}               # 删除流程
POST   /api/v1/processes/{id}/start         # 启动流程
POST   /api/v1/processes/{id}/suspend       # 挂起流程
```

#### 4.1.2 统一响应格式

```java
package com.bank.workfolw.adapter.web.response;

import lombok.Data;

/**
 * 统一响应格式
 */
@Data
public class ApiResponse<T> {
    /** 响应码：200-成功，400-客户端错误，500-服务端错误 */
    private Integer code;
    /** 响应消息 */
    private String message;
    /** 响应数据 */
    private T data;
    /** 时间戳 */
    private Long timestamp;
    
    public static <T> ApiResponse<T> success(T data) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setCode(200);
        response.setMessage("success");
        response.setData(data);
        response.setTimestamp(System.currentTimeMillis());
        return response;
    }
    
    public static <T> ApiResponse<T> error(Integer code, String message) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setCode(code);
        response.setMessage(message);
        response.setTimestamp(System.currentTimeMillis());
        return response;
    }
}
```

### 4.2 核心 API 接口设计

#### 4.2.1 流程管理 API

```java
/**
 * 流程管理API
 */
@RestController
@RequestMapping("/api/v1/processes")
@RequiredArgsConstructor
public class ProcessController {
    
    /**
     * 查询流程定义列表
     * GET /api/v1/processes/definitions
     */
    @GetMapping("/definitions")
    public ApiResponse<PageResult<ProcessDefinitionVO>> listDefinitions(
        @RequestParam(required = false) String keyword,
        @RequestParam(required = false) Long categoryId,
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size
    ) {
        // 实现代码
    }
    
    /**
     * 启动流程实例
     * POST /api/v1/processes/instances
     */
    @PostMapping("/instances")
    public ApiResponse<String> startInstance(@RequestBody StartProcessRequest request) {
        // 实现代码
    }
    
    /**
     * 查询流程实例详情
     * GET /api/v1/processes/instances/{instanceId}
     */
    @GetMapping("/instances/{instanceId}")
    public ApiResponse<ProcessInstanceVO> getInstanceDetail(@PathVariable String instanceId) {
        // 实现代码
    }
    
    /**
     * 挂起流程实例
     * POST /api/v1/processes/instances/{instanceId}/suspend
     */
    @PostMapping("/instances/{instanceId}/suspend")
    public ApiResponse<Void> suspendInstance(@PathVariable String instanceId) {
        // 实现代码
    }
    
    /**
     * 获取流程图（高亮显示当前节点）
     * GET /api/v1/processes/instances/{instanceId}/diagram
     */
    @GetMapping("/instances/{instanceId}/diagram")
    public void getProcessDiagram(@PathVariable String instanceId, HttpServletResponse response) {
        // 实现代码
    }
}
```

#### 4.2.2 任务管理 API

```java
/**
 * 任务管理API
 */
@RestController
@RequestMapping("/api/v1/tasks")
@RequiredArgsConstructor
public class TaskController {
    
    /**
     * 查询待办任务列表
     * GET /api/v1/tasks/todo
     */
    @GetMapping("/todo")
    public ApiResponse<PageResult<TaskVO>> getTodoTasks(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size
    ) {
        // 实现代码
    }
    
    /**
     * 完成任务
     * POST /api/v1/tasks/{taskId}/complete
     */
    @PostMapping("/{taskId}/complete")
    public ApiResponse<Void> completeTask(
        @PathVariable String taskId,
        @RequestBody CompleteTaskRequest request
    ) {
        // 实现代码
    }
    
    /**
     * 转办任务
     * POST /api/v1/tasks/{taskId}/transfer
     */
    @PostMapping("/{taskId}/transfer")
    public ApiResponse<Void> transferTask(
        @PathVariable String taskId,
        @RequestBody TransferTaskRequest request
    ) {
        // 实现代码
    }
    
    /**
     * 委派任务
     * POST /api/v1/tasks/{taskId}/delegate
     */
    @PostMapping("/{taskId}/delegate")
    public ApiResponse<Void> delegateTask(
        @PathVariable String taskId,
        @RequestBody DelegateTaskRequest request
    ) {
        // 实现代码
    }
}
```

### 4.3 认证授权机制

#### 4.3.1 JWT Token 方案

```java
/**
 * JWT工具类
 */
@Component
public class JwtTokenUtil {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    /**
     * 生成Token
     */
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("username", userDetails.getUsername());
        claims.put("authorities", userDetails.getAuthorities());
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(userDetails.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    /**
     * 验证Token
     */
    public Boolean validateToken(String token, UserDetails userDetails) {
        String username = getUsernameFromToken(token);
        return username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }
}
```

#### 4.3.2 权限控制

```java
/**
 * 权限注解
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    String[] value();
}

/**
 * 权限拦截器
 */
@Aspect
@Component
public class PermissionAspect {
    
    @Around("@annotation(requiresPermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, RequiresPermission requiresPermission) throws Throwable {
        // 获取当前用户
        UserDetails user = SecurityContextHolder.getContext().getAuthentication();
        
        // 检查权限
        String[] requiredPermissions = requiresPermission.value();
        boolean hasPermission = checkUserPermissions(user, requiredPermissions);
        
        if (!hasPermission) {
            throw new PermissionDeniedException("权限不足");
        }
        
        return joinPoint.proceed();
    }
}
```

## 五、总结

本文档提供了完整的 COLA 架构适配方案，包括：

1. **分层架构设计**：清晰的四层架构（Adapter、App、Domain、Infrastructure）
2. **Flowable 集成**：详细的配置和使用示例
3. **数据库设计**：完整的表结构和索引优化
4. **API 设计**：RESTful 规范和核心接口
5. **认证授权**：JWT Token 和权限控制方案

**核心优势**：
- ✅ 清晰的分层，职责明确
- ✅ 高内聚，低耦合
- ✅ 易于测试和维护
- ✅ 支持复杂业务场景
- ✅ 符合企业级开发规范

**下一步**：
1. 根据本文档搭建项目骨架
2. 实现核心功能模块
3. 进行前后端联调
4. 完善监控和日志

